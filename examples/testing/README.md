# Testing Pipeline for MDAsim 2.0

This pipeline tests the output of MDAsim for for presence and correctness of single nucleotide errors.

## Usage
### Prerequisites
You must have installed [Conda](https://conda.io/docs/) in order to run the pipeline. Once you have installed Conda, you need to navigate to the `examples/testing`-folder and create an environment using:
```
$ conda create --name mdasim_analysis -c bioconda --file requirements.txt
```
### Step 1
Run MDAsim 2.0 and create a log-file while doing so. The log file contains all single nucleotide substitutions generated by the software during the amplification process. If you haven't run MDAsim yet, do:
```
$ make clean
$ make prefix=.
```
To run the pipeline with the default error rate while generating the log file, in the root folder of the project do:
```
$ bin/mdasim --input=<PATH/TO/YOUR/INPUT/SEQUENCE>.fa --primers=examples/primerList.fasta --log=<LOG>.log
```
### Step 2
Navigate to `examples/testing` and open `config.yaml`. Insert the paths to the required files on your system.

### Step 3
Run
```
$ source activate mdasim_analysis
```
followed by
```
$ snakemake
```

## Output
The pipeline generates the following files in the folder `examples/testing/output`:
- aln.sam
- aln.bam
- aln_sorted.bam
- aln.out
- summary.txt
- comparison.txt

of which `summary.txt` and `comparison.txt` are of further interest for the user.

`summary.txt` includes all positions of the input sequence where a SNP has been found after the MDAsim-output has been mapped onto the original sequence.
```
#pos	ref	alt	r_cnt	a_cnt
35678	C	T	890	    167
103604	T	C	359	    166
                ...
```
`comparison.txt` includes all types of single nucleotide substitutions, the number of each type in the log file that is generated by MDAsim and in the mapping generated by the pipeline and summarized in `summary.txt`:
```
#substitution	log_cnt		sum_cnt
A to T 		    42		    46
A to C 		    46		    43
                ...
```

## Results
A sample run with a sequence of size 213,5 kB resulted in the following counts as stated by `comparison.txt`
```
#substitution	log_cnt		sum_cnt
A to T 		    42		    46
A to C 		    46		    43
A to G 		    50		    52
T to A 		    43		    39
T to C 		    51		    49
T to G 		    45		    46
C to A 		    42		    44
C to T 		    42		    51
C to G 		    63		    72
G to A 		    47		    38
G to T 		    51		    48
G to C 		    51		    42
```

## Credits
The pipeline runs via Snakemake 3.5 in Python 3.5 and uses [minimap 2.8](https://github.com/lh3/minimap2/blob/master/README.md) ([Li, H. (2017). Minimap2: fast pairwise alignment for long nucleotide sequences](https://arxiv.org/abs/1708.01492)) and [samtools 1.7](http://www.htslib.org/) as well as our own scripts for analyzing and summarizing the files to make them human readable.
